<?php

/**
 * Cliente
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    hub-usmjesus
 * @subpackage model
 * @author     Jesus Salazar - usmjesus@gmail.com
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class Cliente extends BaseCliente
{
    
     public function __toString() {
        return $this->getDni().' - '.$this->getNombre().' '.$this->getApellido();
    }
    
     public function getProveedorId($id){
        $q = Doctrine_Query::create()
            -> from('Cliente c')
            ->where('c.is_active = ?', '1')
            ->addWhere('c.id=?', $id);
       return $q->fetchOne();
       
    }
   
   public function getClientesPager(){
       $q = Doctrine_Query::create()
            -> from('Cliente p')
            ->where('p.empresa_id=?', sfContext::getInstance()->getUser()->getAttribute('agente_user_empresa_id'));
       return $q;
    }
   
     public function getAgentes(){
        $q = Doctrine_Query::create()
            -> from('Cliente c')
            ->where('c.is_active = ?', '1')
            ->addWhere('c.empresa_id=?', sfContext::getInstance()->getUser()->getAttribute('agente_user_empresa_id'))
            ->leftJoin('c.ClientePermission s')
            ->addWhere('s.permission_id=3 or s.permission_id=2');
       return $q->execute();
       
    }
    public function getAgentesCC(){
        $q = Doctrine_Query::create()
            -> from('Cliente c')
            ->where('c.is_active = ?', '1')
            ->addWhere('c.empresa_id=?', sfContext::getInstance()->getUser()->getAttribute('agente_user_empresa_id'))
            ->leftJoin('c.ClientePermission s')
            ->addWhere('s.permission_id=3');
       return $q->execute();
       
    }
    public function getAgente($id){
        $q = Doctrine_Query::create()
            -> from('Cliente c')
            ->where('c.is_active = ?', '1')
            ->addWhere('c.empresa_id=?', sfContext::getInstance()->getUser()->getAttribute('agente_user_empresa_id'))
            ->leftJoin('c.ClientePermission s')
            ->addWhere("c.id=$id")
            ->addWhere('s.permission_id=3')
            ->orderBy('c.username');
       return $q->execute();
       
    }
    
    public function getOperador(){
        $q = Doctrine_Query::create()
            -> from('Cliente c')
            ->where('c.is_active = ?', '1')
            ->addWhere('c.empresa_id=?', sfContext::getInstance()->getUser()->getAttribute('agente_user_empresa_id'))
            ->leftJoin('c.ClientePermission s')
            ->addWhere('s.permission_id=7');
       return $q;
       
    }
    
    public function getPersonal(){
         $q = Doctrine_Query::create()
            -> from('Cliente c')
            ->addWhere('c.empresa_id=?', sfContext::getInstance()->getUser()->getAttribute('agente_user_empresa_id'));
       return $q->execute();
       
    }
    
    public function getPersonalAll($permi = 0){
         $q = Doctrine_Query::create()
            -> from('Cliente c')
            ->addWhere('c.empresa_id=?', sfContext::getInstance()->getUser()->getAttribute('agente_user_empresa_id'))
            ->leftJoin('c.ClientePermission s on c.id = s.user_id');
            if($permi>0){
            $q->addWhere('s.permission_id='.$permi);
            }
       return $q->execute();
       
    }
    
    public function getGerenteCallcenter(){
        $q = Doctrine_Query::create()
            -> from('Cliente c')
            ->where('c.is_active = ?', '1')
            ->addWhere('c.empresa_id=?', sfContext::getInstance()->getUser()->getAttribute('agente_user_empresa_id'))
            ->leftJoin('c.ClientePermission s')
            ->addWhere('s.permission_id=2');
       return $q->fetchOne();
    }
    
    
     public function getEmpleadosTotal(){
       $q = Doctrine_Query::create()
            ->select(' COUNT(c.id) as cant')
            -> from('Cliente c')
            ->where('c.empresa_id = ?',sfContext::getInstance()->getUser()->getAttribute('agente_user_empresa_id'))
            ->groupBy('c.empresa_id');
       
       return $q->execute();
       
    }
}
